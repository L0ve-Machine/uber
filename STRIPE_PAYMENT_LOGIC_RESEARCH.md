# Stripeæ±ºæ¸ˆãƒ­ã‚¸ãƒƒã‚¯ å®Œå…¨èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

èª¿æŸ»æ—¥: 2025-11-30

---

## æ¥­ç•Œã®å®Ÿéš›ã®æ‰‹æ•°æ–™ç‡ï¼ˆèª¿æŸ»çµæœï¼‰

### Uber Eatsï¼ˆæ—¥æœ¬ï¼‰

**ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰å¾´å**:
- æ‰‹æ•°æ–™ç‡: **35%**ï¼ˆé…é”ä»£è¡Œåˆ©ç”¨æ™‚ï¼‰
- å®Ÿè³ª: **38%**ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹æ±ºæ¸ˆæ‰‹æ•°æ–™3%å«ã‚€ï¼‰
- ãƒ—ãƒ©ãƒ³åˆ¥:
  - Lite: 15%ï¼ˆãƒ‡ãƒªãƒãƒªãƒ¼ï¼‰+ 6%ï¼ˆãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
  - Plus: 25%ï¼ˆãƒ‡ãƒªãƒãƒªãƒ¼ï¼‰+ 6%ï¼ˆãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰
  - Premium: 30%ï¼ˆãƒ‡ãƒªãƒãƒªãƒ¼ï¼‰+ 6%ï¼ˆãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰

**é¡§å®¢ã‹ã‚‰å¾´å**:
- ã‚µãƒ¼ãƒ“ã‚¹æ–™: **ç´„10%**ï¼ˆæ³¨æ–‡é‡‘é¡ã«ã‚ˆã‚‹ï¼‰
- é…é€æ–™: **å¤‰å‹•**ï¼ˆè·é›¢ãƒ»æ™‚é–“ãƒ»éœ€è¦ã§å¤‰åŒ–ï¼‰
- å°‘é¡æ³¨æ–‡æ‰‹æ•°æ–™: **Â¥150**ï¼ˆ780å††æœªæº€ã®æ³¨æ–‡ï¼‰

**é…é”å“¡å ±é…¬**:
- æƒ…å ±éå…¬é–‹
- æ¨å®š: é…é€æ–™ã®ä¸€éƒ¨ + ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è£œåŠ©

---

### å‡ºå‰é¤¨ï¼ˆæ—¥æœ¬ï¼‰

**ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰å¾´å**:
- é…é”ä»£è¡Œåˆ©ç”¨: **35%**
  - ã‚µãƒ¼ãƒ“ã‚¹æ‰‹æ•°æ–™: 10%
  - é…é”ä»£è¡Œæ‰‹æ•°æ–™: 25%
- è‡ªç¤¾é…é”: **7-10%**
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹æ±ºæ¸ˆæ‰‹æ•°æ–™: **æœ€å¤§3%**
- å®Ÿè³ªåˆè¨ˆ: **38%**

**é…é”å“¡å ±é…¬**:
- åŸºæœ¬å ±é…¬: **Â¥400/ä»¶**ï¼ˆå…¨å›½ä¸€å¾‹ï¼‰
- ãƒ–ãƒ¼ã‚¹ãƒˆ: **1.1ã€œ3å€**
- å¹³å‡: **Â¥650-750/ä»¶**

---

### DoorDashï¼ˆç±³å›½ï¼‰

**ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‹ã‚‰å¾´å**:
- æ¨™æº–: **15-30%**
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æ³¨æ–‡ã®ã¿: **0%**ï¼ˆæ±ºæ¸ˆæ‰‹æ•°æ–™2.9% + $0.30ã®ã¿ï¼‰

**é¡§å®¢ã‹ã‚‰å¾´å**:
- é…é€æ–™: **$2-5**
- ã‚µãƒ¼ãƒ“ã‚¹æ–™: **æœ€å¤§15%**

---

## æ­£ã—ã„é‡‘é¡ã®æµã‚Œï¼ˆèª¿æŸ»çµæœã‚’åŸºã«ï¼‰

### ä¾‹: Â¥3,000ã®æ³¨æ–‡

```
ã€é¡§å®¢ãŒæ”¯æ‰•ã†å†…è¨³ã€‘
å•†å“ä»£: Â¥2,000
é…é€æ–™: Â¥400
ã‚µãƒ¼ãƒ“ã‚¹æ–™: Â¥300ï¼ˆ15%ï¼‰
å°‘é¡æ³¨æ–‡æ‰‹æ•°æ–™: Â¥0
æ¶ˆè²»ç¨: Â¥270ï¼ˆ10%ï¼‰
åˆè¨ˆ: Â¥2,970

ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒå—ã‘å–ã‚‹ã€‘
Stripeæ±ºæ¸ˆ: Â¥2,970
Stripeæ‰‹æ•°æ–™: -Â¥107ï¼ˆ3.6%ï¼‰
å®Ÿéš›ã®å—å–: Â¥2,863

ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ”¯æ‰•ã„ã€‘
1. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¸:
   å•†å“ä»£ Â¥2,000 Ã— (1 - 0.35) = Â¥1,300
   ï¼ˆ35%ãƒãƒ¼ã‚¸ãƒ³ = Â¥700ï¼‰

2. é…é”å“¡ã¸:
   åŸºæœ¬å ±é…¬ Â¥400
   ï¼ˆé…é€æ–™Â¥400ã‹ã‚‰å…¨é¡ï¼‰

3. ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«æ®‹ã‚‹:
   ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒãƒ¼ã‚¸ãƒ³: Â¥700
   é…é€æ–™ãƒãƒ¼ã‚¸ãƒ³: Â¥0ï¼ˆå…¨é¡é…é”å“¡ã¸ï¼‰
   ã‚µãƒ¼ãƒ“ã‚¹æ–™: Â¥300
   æ¶ˆè²»ç¨: Â¥270
   å°è¨ˆ: Â¥1,270
   Stripeæ‰‹æ•°æ–™: -Â¥107
   ç´”åˆ©ç›Š: Â¥1,163
```

---

## ãƒãƒ¼ã‚¸ãƒ³ãŒç™ºç”Ÿã™ã‚‹ç®‡æ‰€ï¼ˆæ­£ç¢ºãªèª¿æŸ»çµæœï¼‰

### 1. Stripeæ‰‹æ•°æ–™ï¼ˆå¿…é ˆã‚³ã‚¹ãƒˆï¼‰

**æ—¥æœ¬ã®Stripeæ‰‹æ•°æ–™**:
- ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ: **3.6%**
- å›½å†…è»¢é€: **ç„¡æ–™**
- Instant Payout: **1.0%è¿½åŠ **

```
Â¥2,970 Ã— 3.6% = Â¥107
```

---

### 2. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒãƒ¼ã‚¸ãƒ³ï¼ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ä¸»è¦åç›Šï¼‰

**æ¥­ç•Œæ¨™æº–**: 15-35%

```
å•†å“ä»£: Â¥2,000
ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ‰‹æ•°æ–™ç‡: 35%
ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒå—ã‘å–ã‚‹: Â¥2,000 Ã— 0.65 = Â¥1,300
ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒ¼ã‚¸ãƒ³: Â¥700
```

**é‡è¦**: ã“ã®Â¥700ãŒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æœ€å¤§ã®åç›Šæº

---

### 3. é…é€æ–™ã®é…åˆ†

**ãƒ‘ã‚¿ãƒ¼ãƒ³A**: é…é”å“¡ã«å…¨é¡æ¸¡ã™ï¼ˆUber Eatsãƒ¢ãƒ‡ãƒ«ï¼‰
```
é¡§å®¢ãŒæ‰•ã†é…é€æ–™: Â¥400
é…é”å“¡ãŒå—ã‘å–ã‚‹: Â¥400
ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ³: Â¥0
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³B**: é…é€æ–™ã‹ã‚‰ã‚‚ãƒãƒ¼ã‚¸ãƒ³ã‚’å–ã‚‹
```
é¡§å®¢ãŒæ‰•ã†é…é€æ–™: Â¥400
é…é”å“¡ãŒå—ã‘å–ã‚‹: Â¥300ï¼ˆ75%ï¼‰
ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ³: Â¥100ï¼ˆ25%ï¼‰
```

**æ¥­ç•Œã®å®Ÿæ…‹**:
- Uber Eats: é…é”å“¡å ±é…¬ã¯éå…¬é–‹ã ãŒã€é…é€æ–™å…¨é¡ã§ã¯ãªã„
- å‡ºå‰é¤¨: é…é”å“¡ã«Â¥400-750å›ºå®šã€é…é€æ–™ã¯å¤‰å‹•ï¼ˆå·®é¡ã¯ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼‰

---

### 4. ã‚µãƒ¼ãƒ“ã‚¹æ–™ï¼ˆ100%ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åç›Šï¼‰

**é¡§å®¢ã‹ã‚‰ç›´æ¥å¾´å**:
```
æ³¨æ–‡é¡ã®10-15%
Â¥2,000 Ã— 15% = Â¥300
```

ã“ã®Â¥300ã¯100%ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®åç›Š

---

## ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®åç›Šæ§‹é€ ï¼ˆå®Œå…¨ç‰ˆï¼‰

### åç›Šæºï¼ˆ3ã¤ï¼‰

```
1. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒãƒ¼ã‚¸ãƒ³: Â¥700ï¼ˆå•†å“ä»£ã®35%ï¼‰
2. é…é€æ–™ãƒãƒ¼ã‚¸ãƒ³: Â¥0-100ï¼ˆé…é€æ–™ã®0-25%ï¼‰
3. ã‚µãƒ¼ãƒ“ã‚¹æ–™: Â¥300ï¼ˆæ³¨æ–‡é¡ã®15%ï¼‰
4. æ¶ˆè²»ç¨: Â¥270ï¼ˆå…¨é¡ä¿æŒï¼‰

åˆè¨ˆåç›Š: Â¥1,270-1,370
```

### ã‚³ã‚¹ãƒˆ

```
1. Stripeæ‰‹æ•°æ–™: Â¥107
2. é…é”å“¡å ±é…¬: Â¥400
3. é‹å–¶ã‚³ã‚¹ãƒˆ: å¤‰å‹•

ç´”åˆ©ç›Š: Â¥763-863
```

---

## Stripe Connectå®Ÿè£…ã‚³ãƒ¼ãƒ‰ï¼ˆæ­£ç¢ºç‰ˆï¼‰

### æ³¨æ–‡ä½œæˆæ™‚

```javascript
// orderController.js - createOrderé–¢æ•°

const itemSubtotal = 2000;              // å•†å“ä»£
const deliveryFee = 400;                // é…é€æ–™
const serviceFee = 300;                 // ã‚µãƒ¼ãƒ“ã‚¹æ–™ï¼ˆ15%ï¼‰
const tax = 270;                        // æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰
const total = 2970;                     // åˆè¨ˆ

// Stripe Payment Intentä½œæˆ
const paymentIntent = await stripe.paymentIntents.create({
  amount: total * 100,  // Â¥2,970 â†’ 297000éŠ­
  currency: 'jpy',
  payment_method_types: ['card'],
  transfer_group: orderNumber,
  metadata: {
    order_id: order.id,
    customer_id: customerId,
    restaurant_id: restaurantId,
    item_subtotal: itemSubtotal,
    delivery_fee: deliveryFee,
    service_fee: serviceFee,
  },
});

// DBã«ä¿å­˜
await order.update({
  stripe_payment_id: paymentIntent.id,
  subtotal: itemSubtotal,
  delivery_fee: deliveryFee,
  service_fee: serviceFee,        // â† æ–°è¦ã‚«ãƒ©ãƒ å¿…è¦
  tax: tax,
  total: total,
});

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™
return {
  clientSecret: paymentIntent.client_secret,
  order: order,
};
```

---

### é…é”å®Œäº†æ™‚ï¼ˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¸è»¢é€ï¼‰

```javascript
// orderController.js - é…é”å®Œäº†æ™‚

// ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒãƒ¼ã‚¸ãƒ³ç‡ã‚’å–å¾—ï¼ˆè¨­å®šå¯èƒ½ã«ã™ã‚‹ï¼‰
const restaurantCommissionRate = 0.35;  // 35%

// ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒå—ã‘å–ã‚‹é‡‘é¡ã‚’è¨ˆç®—
const restaurantPayout = order.subtotal * (1 - restaurantCommissionRate);
// Â¥2,000 Ã— 0.65 = Â¥1,300

// ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«è»¢é€
const restaurantTransfer = await stripe.transfers.create({
  amount: Math.round(restaurantPayout * 100),  // Â¥1,300 â†’ 130000éŠ­
  currency: 'jpy',
  destination: restaurant.stripe_account_id,
  transfer_group: order.order_number,
  metadata: {
    order_id: order.id,
    type: 'restaurant_payout',
    original_amount: order.subtotal,
    commission_rate: restaurantCommissionRate,
    commission_amount: order.subtotal * restaurantCommissionRate,
  },
  description: `æ³¨æ–‡ ${order.order_number} - ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ”¯æ‰•ã„`,
});

// DBã«è¨˜éŒ²
await order.update({
  restaurant_payout: restaurantPayout,
  restaurant_commission: order.subtotal * restaurantCommissionRate,
  stripe_restaurant_transfer_id: restaurantTransfer.id,
});
```

---

### é…é”å®Œäº†æ™‚ï¼ˆé…é”å“¡ã¸è»¢é€ï¼‰

```javascript
// é…é”å“¡å ±é…¬ã‚’è¨ˆç®—ï¼ˆé…é€æ–™å…¨é¡ or å›ºå®šé¡ï¼‰
const driverPayout = order.delivery_fee;  // Â¥400ï¼ˆå…¨é¡ï¼‰
// ã¾ãŸã¯
// const driverPayout = 400;  // å›ºå®šå ±é…¬

// é…é”å“¡ã«è»¢é€
const driverTransfer = await stripe.transfers.create({
  amount: Math.round(driverPayout * 100),  // Â¥400 â†’ 40000éŠ­
  currency: 'jpy',
  destination: driver.stripe_account_id,
  transfer_group: order.order_number,
  metadata: {
    order_id: order.id,
    type: 'driver_payout',
    delivery_fee: order.delivery_fee,
  },
  description: `æ³¨æ–‡ ${order.order_number} - é…é”å“¡å ±é…¬`,
});

// DBã«è¨˜éŒ²
await order.update({
  driver_payout: driverPayout,
  stripe_driver_transfer_id: driverTransfer.id,
});
```

---

### ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åç›Šã®è¨ˆç®—

```javascript
// åç›Šè¨ˆç®—ï¼ˆDBã«ä¿å­˜ï¼‰
const platformRevenue =
  (order.subtotal * restaurantCommissionRate) +  // Â¥700ï¼ˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒãƒ¼ã‚¸ãƒ³ï¼‰
  (order.delivery_fee - driverPayout) +          // Â¥0ï¼ˆé…é€æ–™ãƒãƒ¼ã‚¸ãƒ³ï¼‰
  order.service_fee +                            // Â¥300ï¼ˆã‚µãƒ¼ãƒ“ã‚¹æ–™ï¼‰
  order.tax;                                     // Â¥270ï¼ˆæ¶ˆè²»ç¨ï¼‰
// åˆè¨ˆ: Â¥1,270

const stripeFee = order.total * 0.036;  // Â¥107
const platformProfit = platformRevenue - stripeFee;  // Â¥1,163

await order.update({
  platform_revenue: platformRevenue,
  platform_profit: platformProfit,
  stripe_processing_fee: stripeFee,
});
```

---

## å¿…è¦ãªDBå¤‰æ›´

### ordersãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã¹ãã‚«ãƒ©ãƒ 

```sql
ALTER TABLE orders
ADD COLUMN service_fee DECIMAL(10,2) DEFAULT 0.00 AFTER delivery_fee,
ADD COLUMN restaurant_commission_rate DECIMAL(5,4) DEFAULT 0.35 AFTER service_fee,
ADD COLUMN restaurant_payout DECIMAL(10,2) AFTER restaurant_commission_rate,
ADD COLUMN driver_payout DECIMAL(10,2) AFTER restaurant_payout,
ADD COLUMN platform_revenue DECIMAL(10,2) AFTER driver_payout,
ADD COLUMN platform_profit DECIMAL(10,2) AFTER platform_revenue,
ADD COLUMN stripe_processing_fee DECIMAL(10,2) AFTER platform_profit,
ADD COLUMN stripe_restaurant_transfer_id VARCHAR(255) AFTER stripe_payment_id,
ADD COLUMN stripe_driver_transfer_id VARCHAR(255) AFTER stripe_restaurant_transfer_id;
```

---

### restaurantsãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã¹ãã‚«ãƒ©ãƒ 

```sql
ALTER TABLE restaurants
ADD COLUMN stripe_account_id VARCHAR(255) NULL,
ADD COLUMN stripe_onboarding_completed BOOLEAN DEFAULT FALSE,
ADD COLUMN stripe_charges_enabled BOOLEAN DEFAULT FALSE,
ADD COLUMN stripe_payouts_enabled BOOLEAN DEFAULT FALSE,
ADD COLUMN commission_rate DECIMAL(5,4) DEFAULT 0.35 COMMENT 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™ç‡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ35%ï¼‰';
```

---

### driversãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã¹ãã‚«ãƒ©ãƒ 

```sql
ALTER TABLE drivers
ADD COLUMN stripe_account_id VARCHAR(255) NULL,
ADD COLUMN stripe_onboarding_completed BOOLEAN DEFAULT FALSE,
ADD COLUMN stripe_charges_enabled BOOLEAN DEFAULT FALSE,
ADD COLUMN stripe_payouts_enabled BOOLEAN DEFAULT FALSE,
ADD COLUMN base_payout_per_delivery DECIMAL(10,2) DEFAULT 400.00 COMMENT 'é…é”1ä»¶ã‚ãŸã‚Šã®åŸºæœ¬å ±é…¬';
```

---

## ç¾åœ¨ã®DBæ§‹é€ ã§ã®å®Ÿè£…å¯èƒ½æ€§

### æ—¢å­˜ã‚«ãƒ©ãƒ ï¼ˆä½¿ç”¨å¯èƒ½ï¼‰

| ã‚«ãƒ©ãƒ  | ç”¨é€” | çŠ¶æ…‹ |
|--------|------|------|
| `subtotal` | å•†å“ä»£ | âœ… å­˜åœ¨ |
| `delivery_fee` | é…é€æ–™ | âœ… å­˜åœ¨ |
| `tax` | æ¶ˆè²»ç¨ | âœ… å­˜åœ¨ |
| `total` | åˆè¨ˆ | âœ… å­˜åœ¨ |
| `stripe_payment_id` | PaymentIntent ID | âœ… å­˜åœ¨ |
| `payment_method` | æ”¯æ‰•ã„æ–¹æ³• | âœ… å­˜åœ¨ |

### ä¸è¶³ã—ã¦ã„ã‚‹ã‚«ãƒ©ãƒ ï¼ˆè¿½åŠ å¿…è¦ï¼‰

| ã‚«ãƒ©ãƒ  | ç”¨é€” | å¿…é ˆåº¦ |
|--------|------|--------|
| `service_fee` | ã‚µãƒ¼ãƒ“ã‚¹æ–™ | âš ï¸ å¿…é ˆ |
| `restaurant_commission_rate` | ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ‰‹æ•°æ–™ç‡ | âš ï¸ å¿…é ˆ |
| `restaurant_payout` | ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ”¯æ‰•é¡ | âš ï¸ å¿…é ˆ |
| `driver_payout` | é…é”å“¡å ±é…¬ | âš ï¸ å¿…é ˆ |
| `platform_revenue` | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åç›Š | æ¨å¥¨ |
| `stripe_restaurant_transfer_id` | Transfer IDï¼ˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰ | æ¨å¥¨ |
| `stripe_driver_transfer_id` | Transfer IDï¼ˆé…é”å“¡ï¼‰ | æ¨å¥¨ |

### Stripe Connectç”¨ã‚«ãƒ©ãƒ 

| ãƒ†ãƒ¼ãƒ–ãƒ« | ã‚«ãƒ©ãƒ  | å¿…é ˆåº¦ |
|---------|--------|--------|
| `restaurants` | `stripe_account_id` | ğŸ”´ å¿…é ˆ |
| `restaurants` | `commission_rate` | âš ï¸ æ¨å¥¨ |
| `drivers` | `stripe_account_id` | ğŸ”´ å¿…é ˆ |
| `drivers` | `base_payout_per_delivery` | æ¨å¥¨ |

---

## å®Ÿè£…å¯èƒ½æ€§ã®åˆ¤å®š

### çµè«–: **å®Ÿè£…å¯èƒ½ã ãŒã€DBå¤‰æ›´ãŒå¿…è¦**

**å¿…é ˆã®å¤‰æ›´**:
1. `orders` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `service_fee`, `restaurant_payout`, `driver_payout` è¿½åŠ 
2. `restaurants` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `stripe_account_id` è¿½åŠ 
3. `drivers` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `stripe_account_id` è¿½åŠ 

**æœ€å°é™ã§å‹•ä½œã•ã›ã‚‹å ´åˆ**:
- `stripe_account_id` ã®ã¿è¿½åŠ 
- æ‰‹æ•°æ–™ç‡ã¯ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼ˆ35%å›ºå®šï¼‰
- æ”¯æ‰•é¡ã¯ãã®å ´ã§è¨ˆç®—ï¼ˆDBã«ä¿å­˜ã—ãªã„ï¼‰

**æ¨å¥¨å®Ÿè£…**:
- å…¨ã‚«ãƒ©ãƒ è¿½åŠ 
- ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã”ã¨ã«æ‰‹æ•°æ–™ç‡ã‚’è¨­å®šå¯èƒ½ã«
- åç›Šã‚’æ­£ç¢ºã«ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

---

## å®Œå…¨ãªå®Ÿè£…ãƒ•ãƒ­ãƒ¼

### Phase 1: Stripe Connectã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ

**ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ç™»éŒ²æ™‚**:
```javascript
// restaurantController.js

// Stripe Connected Accountã‚’ä½œæˆ
const account = await stripe.accounts.create({
  type: 'express',
  country: 'JP',
  email: restaurant.email,
  capabilities: {
    card_payments: { requested: true },
    transfers: { requested: true },
  },
  business_type: 'company',
  business_profile: {
    name: restaurant.name,
    product_description: 'Restaurant food service',
  },
});

// DBã«ä¿å­˜
await restaurant.update({
  stripe_account_id: account.id,
});

// ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒªãƒ³ã‚¯ä½œæˆ
const accountLink = await stripe.accountLinks.create({
  account: account.id,
  refresh_url: 'https://yourapp.com/restaurant/stripe/refresh',
  return_url: 'https://yourapp.com/restaurant/stripe/return',
  type: 'account_onboarding',
});

// ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã«ãƒªãƒ³ã‚¯ã‚’é€ã‚‹
return { onboarding_url: accountLink.url };
```

**é…é”å“¡ç™»éŒ²æ™‚**:
```javascript
// driverController.js

const account = await stripe.accounts.create({
  type: 'express',
  country: 'JP',
  email: driver.email,
  capabilities: {
    transfers: { requested: true },
  },
  business_type: 'individual',
  individual: {
    first_name: driver.first_name,
    last_name: driver.last_name,
    email: driver.email,
  },
});

await driver.update({
  stripe_account_id: account.id,
});
```

---

### Phase 2: æ³¨æ–‡æ™‚ã®æ±ºæ¸ˆ

**ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆç”»é¢**:
```javascript
// Flutterå´
final response = await checkoutApiService.createPaymentIntent(
  orderId: order.id,
);

// Stripe Elementã§æ±ºæ¸ˆ
final paymentIntent = await Stripe.instance.confirmPayment(
  paymentIntentClientSecret: response.clientSecret,
);
```

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:
```javascript
// orderController.js - createPaymentIntent

// é‡‘é¡è¨ˆç®—
const itemSubtotal = calculateItemTotal(items);
const deliveryFee = restaurant.delivery_fee;
const serviceFeeRate = 0.15;  // 15%
const serviceFee = Math.round(itemSubtotal * serviceFeeRate);
const subtotalBeforeTax = itemSubtotal + deliveryFee + serviceFee;
const tax = Math.round(subtotalBeforeTax * 0.10);  // 10%
const total = subtotalBeforeTax + tax;

// Payment Intentä½œæˆ
const paymentIntent = await stripe.paymentIntents.create({
  amount: total * 100,
  currency: 'jpy',
  payment_method_types: ['card'],
  transfer_group: orderNumber,
  metadata: {
    order_id: orderId,
    customer_id: customerId,
  },
});

return {
  clientSecret: paymentIntent.client_secret,
  amount: total,
};
```

---

### Phase 3: é…é”å®Œäº†æ™‚ã®è»¢é€

**Webhookå‡¦ç†**:
```javascript
// webhookController.js

app.post('/webhook/stripe', async (req, res) => {
  const event = stripe.webhooks.constructEvent(
    req.body,
    req.headers['stripe-signature'],
    process.env.STRIPE_WEBHOOK_SECRET
  );

  if (event.type === 'payment_intent.succeeded') {
    const paymentIntent = event.data.object;
    const orderId = paymentIntent.metadata.order_id;

    // æ³¨æ–‡ã‚’å–å¾—
    const order = await Order.findByPk(orderId, {
      include: ['restaurant', 'driver']
    });

    // é…é”å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿è»¢é€
    if (order.status === 'delivered') {
      await processPayouts(order);
    }
  }

  res.json({ received: true });
});

async function processPayouts(order) {
  // 1. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¸è»¢é€
  const restaurantCommissionRate = order.restaurant.commission_rate || 0.35;
  const restaurantPayout = order.subtotal * (1 - restaurantCommissionRate);

  await stripe.transfers.create({
    amount: Math.round(restaurantPayout * 100),
    currency: 'jpy',
    destination: order.restaurant.stripe_account_id,
    transfer_group: order.order_number,
    source_transaction: order.stripe_payment_id,
  });

  // 2. é…é”å“¡ã¸è»¢é€
  const driverPayout = order.driver.base_payout_per_delivery || order.delivery_fee;

  await stripe.transfers.create({
    amount: Math.round(driverPayout * 100),
    currency: 'jpy',
    destination: order.driver.stripe_account_id,
    transfer_group: order.order_number,
    source_transaction: order.stripe_payment_id,
  });

  // 3. åç›Šè¨ˆç®—
  const platformRevenue =
    (order.subtotal * restaurantCommissionRate) +
    (order.delivery_fee - driverPayout) +
    order.service_fee +
    order.tax;

  await order.update({
    restaurant_payout: restaurantPayout,
    driver_payout: driverPayout,
    platform_revenue: platformRevenue,
    payout_completed: true,
  });
}
```

---

## å®Ÿè£…ã®å¯å¦åˆ¤å®š

### âœ… å®Ÿè£…å¯èƒ½

**ç†ç”±**:
1. Stripe SDKã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼ˆpackage.jsonï¼‰
2. åŸºæœ¬çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã¯å­˜åœ¨
3. Payment Intentç”¨ã®ã‚«ãƒ©ãƒ ã‚ã‚Šï¼ˆstripe_payment_idï¼‰

### âš ï¸ å¿…è¦ãªä½œæ¥­

**å¿…é ˆ**:
1. DBå¤‰æ›´ï¼ˆ9ã‚«ãƒ©ãƒ è¿½åŠ ï¼‰
2. Stripe Connectè¨­å®šï¼ˆç®¡ç†ç”»é¢ï¼‰
3. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ»é…é”å“¡ã®ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ•ãƒ­ãƒ¼
4. Webhookå®Ÿè£…

**æ¨å®šå·¥æ•°**:
- DBå¤‰æ›´: 10åˆ†
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…: 3-4æ™‚é–“
- Flutterå®Ÿè£…: 2-3æ™‚é–“
- ãƒ†ã‚¹ãƒˆ: 1-2æ™‚é–“
- åˆè¨ˆ: **6-9æ™‚é–“**

---

## æ­£ã—ã„ç†è§£ï¼ˆæœ€çµ‚ç‰ˆï¼‰

### ã‚ãªãŸã®ç†è§£ã¯å®Œå…¨ã«æ­£ã—ã„

**æ”¯æ‰•ã„å†…è¨³**:
```
é¡§å®¢ãŒæ”¯æ‰•ã†: å•†å“ä»£ + é…é€æ–™ + ã‚µãƒ¼ãƒ“ã‚¹æ–™ + ç¨
```

**ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãŒå—ã‘å–ã‚‹**:
```
å•†å“ä»£ Ã— 0.65ï¼ˆ35%ãƒãƒ¼ã‚¸ãƒ³ï¼‰
```

**é…é”å“¡ãŒå—ã‘å–ã‚‹**:
```
é…é€æ–™ï¼ˆå…¨é¡ã¾ãŸã¯å›ºå®šé¡ï¼‰
```

**ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒå—ã‘å–ã‚‹**:
```
1. ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒãƒ¼ã‚¸ãƒ³ï¼ˆ35%ï¼‰
2. ã‚µãƒ¼ãƒ“ã‚¹æ–™ï¼ˆ100%ï¼‰
3. é…é€æ–™ã®ä¸€éƒ¨ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
4. æ¶ˆè²»ç¨ï¼ˆ100%ï¼‰
```

---

Sources:
- [Uber Eats ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æ‰‹æ•°æ–™ 2025å¹´æœ€æ–°](https://aumo.jp/articles/646619)
- [Uber Eats åº—èˆ—å´æ‰‹æ•°æ–™ã®ãƒªã‚¢ãƒ«](https://012cloud.jp/article/uber-eats-comission)
- [å‡ºå‰é¤¨ åŠ ç›Ÿåº—æ‰‹æ•°æ–™35%](https://www.delinavi.net/entry/å‡ºå‰é¤¨_åŠ ç›Ÿåº—)
- [Uber Eats Commission Fee Breakdown](https://www.restolabs.com/blog/uber-eats-commission-fee)
- [Stripe Connect Implementation Tutorial](https://www.cjav.dev/articles/taking-a-cut-with-stripe-connect)
- [Food Delivery Platform Revenue Models](https://pubsonline.informs.org/doi/10.1287/mnsc.2023.00435)
